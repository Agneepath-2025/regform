name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA to rollback to (leave empty for previous commit)'
        required: false
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    
    steps:
      - name: Rollback to previous version
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üîÑ Starting rollback process..."
            
            cd ~/regform || cd /var/www/regform
            
            # Stop current container
            echo "üõë Stopping current containers..."
            docker-compose -f docker-compose.host-mongo.yml down
            
            # Determine rollback target
            if [ -n "${{ github.event.inputs.commit_sha }}" ]; then
              ROLLBACK_TARGET="${{ github.event.inputs.commit_sha }}"
              echo "üìç Rolling back to specified commit: $ROLLBACK_TARGET"
            else
              ROLLBACK_TARGET="HEAD^"
              echo "üìç Rolling back to previous commit"
            fi
            
            # Rollback code
            echo "‚è™ Checking out $ROLLBACK_TARGET..."
            git fetch origin
            git checkout $ROLLBACK_TARGET
            
            # Rebuild and restart
            echo "üê≥ Rebuilding Docker image..."
            docker-compose -f docker-compose.host-mongo.yml build --no-cache
            
            echo "üöÄ Starting rolled-back version..."
            docker-compose -f docker-compose.host-mongo.yml up -d
            
            # Wait and verify
            echo "‚è≥ Waiting for container to start..."
            sleep 15
            
            echo "üìä Container status:"
            docker-compose -f docker-compose.host-mongo.yml ps
            
            # Health check
            if curl -f http://localhost:7000/api/health > /dev/null 2>&1; then
              echo "‚úÖ Rollback completed successfully!"
              echo "Current commit: $(git rev-parse HEAD)"
            else
              echo "‚ùå Rollback health check failed!"
              docker-compose -f docker-compose.host-mongo.yml logs --tail=50 app
              exit 1
            fi

      - name: Notify rollback status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Rollback successful"
          else
            echo "‚ùå Rollback failed - manual intervention required"
          fi
